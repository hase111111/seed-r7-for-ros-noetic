#!/usr/bin/env python3

from tork_moveit_tutorial import *
import numpy as np
import rospy
import moveit_commander
from trajectory_msgs.msg import JointTrajectory, JointTrajectoryPoint
from moveit_msgs.msg import RobotTrajectory

##-- for hand control
from seed_r7_ros_controller.srv import*

move_group_name = 'larm_with_waist'

name_list = ['waist_y_joint',
 'waist_p_joint',
 'waist_r_joint',
 'l_shoulder_p_joint',
 'l_shoulder_r_joint',
 'l_shoulder_y_joint',
 'l_elbow_joint',
 'l_elbow_joint_mimic',
 'l_elbow_middle_joint',
 'l_elbow_middle_joint_mimic',
 'l_wrist_y_joint',
 'l_wrist_p_joint',
 'l_wrist_r_joint',
 'l_wrist_to_hand_connector',
 'l_eef_grasp_joint']

theta_opt = [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
 [ 0.0000,  0.0000,  0.0000, -0.0024, -0.0091, -0.0213, -0.0401, -0.0657,
  -0.0983, -0.1377, -0.1833, -0.2342, -0.2896, -0.3482, -0.4089, -0.4701,
  -0.5308, -0.5894, -0.6448, -0.6957, -0.7413, -0.7807, -0.8133, -0.8389,
  -0.8577, -0.8699, -0.8766, -0.8790, -0.8790, -0.8790],
 [ 1.5700,  1.5700,  1.5700,  1.5669,  1.5559,  1.5358,  1.5051,  1.4630,
   1.4095,  1.3449,  1.2702,  1.1866,  1.0958,  0.9996,  0.9002,  0.7996,
   0.7002,  0.6040,  0.5132,  0.4296,  0.3549,  0.2903,  0.2368,  0.1947,
   0.1640,  0.1439,  0.1329,  0.1290,  0.1290,  0.1290],
 [ 0.0000,  0.0000,  0.0000, -0.0043, -0.0161, -0.0378, -0.0710, -0.1165,
  -0.1744, -0.2443, -0.3251, -0.4155, -0.5137, -0.6176, -0.7251, -0.8339,
  -0.9414, -1.0453, -1.1435, -1.2339, -1.3147, -1.3846, -1.4425, -1.4880,
  -1.5212, -1.5429, -1.5547, -1.5590, -1.5590, -1.5590],
 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
 [ 0.0000,  0.0000,  0.0000, -0.0005, -0.0021, -0.0048, -0.0091, -0.0149,
  -0.0223, -0.0312, -0.0415, -0.0530, -0.0656, -0.0788, -0.0926, -0.1064,
  -0.1202, -0.1334, -0.1460, -0.1575, -0.1678, -0.1767, -0.1841, -0.1899,
  -0.1942, -0.1969, -0.1985, -0.1990, -0.1990, -0.1990]]

theta_opt_move_item = [[ 0.0000,  0.0000,  0.0000, -0.0006, -0.0024, -0.0059, -0.0114, -0.0193,
  -0.0298, -0.0431, -0.0594, -0.0787, -0.1010, -0.1264, -0.1547, -0.1858,
  -0.2196, -0.2559, -0.2945, -0.3351, -0.3775, -0.4213, -0.4662, -0.5120,
  -0.5583, -0.6048, -0.6511, -0.6969, -0.7419, -0.7858, -0.8281, -0.8688,
  -0.9073, -0.9437, -0.9775, -1.0087, -1.0370, -1.0624, -1.0848, -1.1041,
  -1.1204, -1.1337, -1.1442, -1.1521, -1.1576, -1.1611, -1.1629, -1.1636,
  -1.1636, -1.1636],
 [-0.8790, -0.8790, -0.8790, -0.8791, -0.8793, -0.8798, -0.8805, -0.8815,
  -0.8828, -0.8845, -0.8866, -0.8890, -0.8919, -0.8951, -0.8988, -0.9028,
  -0.9071, -0.9118, -0.9167, -0.9219, -0.9274, -0.9330, -0.9388, -0.9447,
  -0.9506, -0.9566, -0.9626, -0.9685, -0.9743, -0.9800, -0.9855, -0.9907,
  -0.9957, -1.0004, -1.0048, -1.0089, -1.0125, -1.0158, -1.0187, -1.0213,
  -1.0234, -1.0251, -1.0265, -1.0275, -1.0282, -1.0287, -1.0289, -1.0290,
  -1.0290, -1.0290],
 [ 0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290],
 [-1.5590, -1.5590, -1.5590, -1.5589, -1.5587, -1.5583, -1.5578, -1.5570,
  -1.5560, -1.5549, -1.5536, -1.5522, -1.5507, -1.5492, -1.5476, -1.5460,
  -1.5445, -1.5431, -1.5417, -1.5405, -1.5395, -1.5386, -1.5380, -1.5375,
  -1.5373, -1.5373, -1.5375, -1.5380, -1.5386, -1.5395, -1.5405, -1.5417,
  -1.5431, -1.5445, -1.5460, -1.5476, -1.5492, -1.5507, -1.5522, -1.5536,
  -1.5549, -1.5560, -1.5570, -1.5578, -1.5583, -1.5587, -1.5589, -1.5590,
  -1.5590, -1.5590],
 [ 0.0000,  0.0000,  0.0000, -0.0000, -0.0001, -0.0003, -0.0005, -0.0008,
  -0.0013, -0.0019, -0.0026, -0.0034, -0.0043, -0.0054, -0.0066, -0.0080,
  -0.0094, -0.0110, -0.0127, -0.0144, -0.0162, -0.0181, -0.0200, -0.0220,
  -0.0240, -0.0260, -0.0280, -0.0300, -0.0319, -0.0338, -0.0356, -0.0373,
  -0.0390, -0.0406, -0.0420, -0.0433, -0.0446, -0.0457, -0.0466, -0.0474,
  -0.0481, -0.0487, -0.0492, -0.0495, -0.0497, -0.0499, -0.0500, -0.0500,
  -0.0500, -0.0500],
 [ 0.0000,  0.0000,  0.0000, -0.0000, -0.0001, -0.0003, -0.0005, -0.0008,
  -0.0013, -0.0019, -0.0026, -0.0034, -0.0043, -0.0054, -0.0066, -0.0080,
  -0.0094, -0.0110, -0.0127, -0.0144, -0.0162, -0.0181, -0.0200, -0.0220,
  -0.0240, -0.0260, -0.0280, -0.0300, -0.0319, -0.0338, -0.0356, -0.0373,
  -0.0390, -0.0406, -0.0420, -0.0433, -0.0446, -0.0457, -0.0466, -0.0474,
  -0.0481, -0.0487, -0.0492, -0.0495, -0.0497, -0.0499, -0.0500, -0.0500,
  -0.0500, -0.0500],
 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000],
 [-0.1990, -0.1990, -0.1990, -0.1991, -0.1992, -0.1995, -0.2000, -0.2007,
  -0.2016, -0.2027, -0.2041, -0.2058, -0.2078, -0.2099, -0.2124, -0.2151,
  -0.2180, -0.2212, -0.2245, -0.2281, -0.2317, -0.2355, -0.2394, -0.2434,
  -0.2474, -0.2515, -0.2555, -0.2595, -0.2634, -0.2672, -0.2708, -0.2744,
  -0.2777, -0.2809, -0.2838, -0.2865, -0.2890, -0.2912, -0.2931, -0.2948,
  -0.2962, -0.2974, -0.2983, -0.2990, -0.2995, -0.2998, -0.2999, -0.3000,
  -0.3000, -0.3000]]

theta_opt_set_item =  [[-1.1636, -1.1636, -1.1636, -1.1636, -1.1636, -1.1636, -1.1636, -1.1636,
  -1.1636, -1.1636],
 [-1.0290, -1.0290, -1.0290, -1.0196, -1.0008, -0.9782, -0.9594, -0.9500,
  -0.9500, -0.9500],
 [ 0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,  0.1290,
   0.1290,  0.1290],
 [-1.5590, -1.5590, -1.5590, -1.5590, -1.5590, -1.5590, -1.5590, -1.5590,
  -1.5590, -1.5590],
 [-0.0500, -0.0500, -0.0500, -0.0500, -0.0500, -0.0500, -0.0500, -0.0500,
  -0.0500, -0.0500],
 [-0.0500, -0.0500, -0.0500, -0.0500, -0.0500, -0.0500, -0.0500, -0.0500,
  -0.0500, -0.0500],
 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
   0.0000,  0.0000],
 [-0.2500, -0.2500, -0.2500, -0.2500, -0.2500, -0.2500, -0.2500, -0.2500,
  -0.2500, -0.2500]]

def make_mapping(theta_opt):
    mapping = dict()

    mapping['waist_y_joint'] = theta_opt[0]
    mapping['l_shoulder_p_joint'] = theta_opt[1]
    mapping['l_shoulder_r_joint'] = theta_opt[2]
    mapping['l_shoulder_y_joint'] = theta_opt[3]
    mapping['l_elbow_joint'] = theta_opt[4]
    # 'l_elbow_joint' は mimic joint なので、実際の関節角度は2倍になる
    mapping['l_elbow_joint'] = [2 * x for x in mapping['l_elbow_joint']]
    mapping['l_elbow_joint_dummy'] = theta_opt[5]
    mapping['l_wrist_y_joint'] = theta_opt[6]
    mapping['l_wrist_r_joint'] = theta_opt[7]
    return mapping

def escape_right_arm():
    group = MoveGroupCommander('rarm')
    group.set_max_velocity_scaling_factor(1.0)
    group.set_max_acceleration_scaling_factor(1.0)
    
    # move to initial position
    name = group.get_active_joints()
    for joint in name:
        group.set_joint_value_target(joint, 0.0)
    group.set_joint_value_target('r_shoulder_r_joint', -np.pi / 3)
    group.go()

    # move to escape position
    group.set_joint_value_target('r_shoulder_r_joint', 0)
    group.go()


def move_initial_position(group, theta_opt):
    mapping = make_mapping(theta_opt)
    for joint in name_list:
        if joint in mapping:
            rospy.loginfo(f"joint = {joint}")
            group.set_joint_value_target(joint, mapping[joint][1])
    group.go()
    

def get_trajectory(theta_opt):
    mapping = make_mapping(theta_opt)
    trajectory = RobotTrajectory()
    trajectory.joint_trajectory.joint_names = name_list
    num_steps = len(theta_opt[0])  # 時間の分割数
    time_step = 0.2  #　各分割の時間
    for i in range(num_steps):
        point = JointTrajectoryPoint()

        # 各時間における関節角度を取得     
        joint_positions = []
        for joint in name_list:
            if joint in mapping:
                joint_positions.append(mapping[joint][i])  # mappingにデータがあればその値を追加
            else:
                joint_positions.append(0.0)  # mappingにデータがなければ0を追加

        # 関節角度を設定
        point.positions = joint_positions

        # 時間を設定
        point.time_from_start = rospy.Duration(time_step * (i + 1))

        # ポイントを追加
        trajectory.joint_trajectory.points.append(point)

    return trajectory

def main():
    group = MoveGroupCommander(move_group_name)
    group.set_max_velocity_scaling_factor(1.0)
    group.set_max_acceleration_scaling_factor(1.0)

    move_initial_position(group, theta_opt)
    
    rospy.loginfo('waiting service')
    rospy.wait_for_service('/seed_r7_ros_controller/hand_control')
    service = rospy.ServiceProxy('/seed_r7_ros_controller/hand_control', HandControl)

    service(1,'release',100)
    # wait for hand to release
    rospy.sleep(1)

    trajectory = get_trajectory(theta_opt)
    group.execute(trajectory, wait=True)

    service(1,'grasp',100)
    # wait for hand to grasp
    rospy.sleep(1)

    trajectory = get_trajectory(theta_opt_move_item)
    group.execute(trajectory, wait=True)

    trajectory = get_trajectory(theta_opt_set_item)
    group.execute(trajectory, wait=True)

    service(1,'release',100)
    # wait for hand to release
    rospy.sleep(1)

    # finish
    rospy.loginfo('finish')
    


if __name__ == '__main__':
    
    init_node()

    escape_right_arm()

    main()